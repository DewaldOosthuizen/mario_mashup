[gd_scene load_steps=8 format=2]

[ext_resource path="res://resources/HUD/health/Health1.png" type="Texture" id=1]
[ext_resource path="res://resources/HUD/health/Health3.png" type="Texture" id=2]
[ext_resource path="res://resources/HUD/health/Health2.png" type="Texture" id=3]
[ext_resource path="res://resources/HUD/power/Power1.png" type="Texture" id=4]
[ext_resource path="res://resources/HUD/power/Power3.png" type="Texture" id=5]
[ext_resource path="res://resources/HUD/power/Power2.png" type="Texture" id=6]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

var level = 0 # starting level
var character = {\"health\": 3, \"power\": 0, \"ammo\": 10, \"type\": \"Robot\"} # player character attributes


# Called when the node enters the scene tree for the first time.
func _ready():
	# set the game to full screen
	OS.window_fullscreen = true
	OS.keep_screen_on = true
	# start the first level
	advance_to_next_level()
	pass
	
	

#Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	# get player input
	handle_events()
	pass


func handle_events():
	# check if the user quits the game
	if (Input.is_action_just_pressed(\"ui_cancel\")):
		if (!OS.window_fullscreen): 
			get_tree().quit()
		else:
			OS.window_fullscreen = false
	pass


# triggered by signals set up in get_end_door() 
func advance_to_next_level():
	
	# remove previous level if exists
	var thisLevel = get_tree().get_nodes_in_group(\"level\").front()
	if (thisLevel):
		thisLevel.queue_free()
	
	# increment level and add next level as active scene
	level += 1;
	var nextLevel_scene = load(\"res://Scenes/Levels/Level_\" + str(level) + \"_Scene.tscn\")
	if (nextLevel_scene):
		# create next level scene
		var nextLevel = nextLevel_scene.instance()
		# add next level to world
		if (nextLevel):
			nextLevel.connect(\"exit_level\", self, \"load_character_and_attributes\")
			nextLevel.connect(\"entered_level\", self, \"setup_level\")
				
	#		get_tree().change_scene_to(nextLevel_scene)
			get_tree().root.call_deferred(\"add_child\", nextLevel)
			# set the next level as the current scene
			get_tree().call_deferred(\"set_current_scene\", nextLevel)
			print(\":: started level \" + str(level) + \" ::\")
	pass
	

func setup_level():
	# get the end door for current level and listen for events, if main character enters the door
	# the signal will emit and the next level will be created
	var end_door = get_tree().get_nodes_in_group(\"end_door\").front()
	if (end_door):
		end_door.connect(\"enteredEndDoor\", self, \"advance_to_next_level\")
		print(\":: end door connected ::\")
	
	if (!get_tree().get_nodes_in_group(\"character\").front()):
		var playerCharacter = load(\"res://Scenes/Characters/\" + character[\"type\"] + \"/Character_Scene.tscn\").instance()
		playerCharacter.ammo = character[\"ammo\"]
		playerCharacter.health = character[\"health\"]
		playerCharacter.power = character[\"power\"]
		playerCharacter.type = character[\"type\"]
		playerCharacter.position.x = 550
		playerCharacter.position.y = 0
		get_tree().root.add_child(playerCharacter)
	else:
		get_tree().get_nodes_in_group(\"character\").front().position.x = 550
		get_tree().get_nodes_in_group(\"character\").front().position.y = 0
	pass


func load_character_and_attributes():
	var playerCharacter = get_tree().get_nodes_in_group(\"character\").front()
	if (playerCharacter):
		character.health = playerCharacter.health
		character.power = playerCharacter.power
		character.ammo = playerCharacter.ammo
		character.type = playerCharacter.type
		
"

[node name="World" type="Node2D"]
position = Vector2( 0, -2.72073 )
script = SubResource( 1 )

[node name="CanvasLayer" type="CanvasLayer" parent="." groups=[
"status_bar",
]]

[node name="HealthProgress" type="TextureProgress" parent="CanvasLayer"]
margin_left = 27.2722
margin_top = 752.194
margin_right = 241.272
margin_bottom = 816.194
rect_scale = Vector2( 0.5, 0.5 )
max_value = 3.0
value = 2.0
texture_under = ExtResource( 1 )
texture_over = ExtResource( 2 )
texture_progress = ExtResource( 3 )
tint_under = Color( 0.564706, 0.0431373, 0.0431373, 1 )
tint_over = Color( 1, 0, 0, 1 )
tint_progress = Color( 0.580392, 0.278431, 0.278431, 1 )

[node name="PowerProgress" type="TextureProgress" parent="CanvasLayer"]
margin_left = 169.77
margin_top = 752.194
margin_right = 383.77
margin_bottom = 816.194
rect_scale = Vector2( 0.5, 0.5 )
max_value = 3.0
value = 2.0
texture_under = ExtResource( 4 )
texture_over = ExtResource( 5 )
texture_progress = ExtResource( 6 )
